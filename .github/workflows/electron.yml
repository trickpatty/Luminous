# =============================================================================
# Luminous - Electron Display App Build and Release Workflow
# =============================================================================
# Builds the Electron display application for Windows, macOS (Intel & Apple
# Silicon), and Linux. Creates GitHub releases with downloadable installers.
#
# Features:
#   - Dynamic Azure API URL configuration per environment
#   - Multi-platform builds (Windows, macOS, Linux)
#   - Support for dev, stg, and prd environments
#
# Phase 2.1: Display Application CI/CD
# TOGAF Principle: TP-4 - Infrastructure as Code
# =============================================================================

name: Electron Display Build and Release

on:
  push:
    branches: [main, develop]
    paths:
      - 'clients/display/**'
      - 'assets/icons/**'
      - '.github/workflows/electron.yml'
    tags:
      - 'display-v*'
  pull_request:
    branches: [main, develop]
    paths:
      - 'clients/display/**'
      - 'assets/icons/**'
      - '.github/workflows/electron.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment for API configuration'
        required: true
        type: choice
        default: 'dev'
        options:
          - dev
          - stg
          - prd
      create_release:
        description: 'Create a GitHub release'
        required: false
        type: boolean
        default: false
      version:
        description: 'Version number (e.g., 0.1.0)'
        required: false
        type: string

env:
  NODE_VERSION: '20.x'
  WORKING_DIRECTORY: ./clients/display
  RG_PREFIX: 'rg-lum'
  # Default to 'dev' for automated builds, can be overridden via workflow_dispatch
  TARGET_ENV: ${{ github.event.inputs.environment || 'dev' }}

defaults:
  run:
    working-directory: ./clients/display

permissions:
  id-token: write
  contents: read

jobs:
  # ===========================================================================
  # Fetch Azure Configuration
  # ===========================================================================
  fetch-azure-config:
    name: Fetch Azure Config (${{ github.event.inputs.environment || 'dev' }})
    runs-on: ubuntu-latest
    outputs:
      static_web_app_url: ${{ steps.get-urls.outputs.static_web_app_url }}
      app_service_url: ${{ steps.get-urls.outputs.app_service_url }}
      environment: ${{ steps.get-urls.outputs.environment }}
      build_config: ${{ steps.get-urls.outputs.build_config }}

    steps:
      - name: Determine environment
        id: env
        run: |
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          echo "environment=$ENV" >> $GITHUB_OUTPUT

          # Map environment to build config
          if [ "$ENV" == "prd" ]; then
            echo "build_config=production" >> $GITHUB_OUTPUT
          else
            echo "build_config=$ENV" >> $GITHUB_OUTPUT
          fi
        working-directory: .

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get Azure URLs
        id: get-urls
        run: |
          ENV="${{ steps.env.outputs.environment }}"
          RG="${{ env.RG_PREFIX }}-$ENV"

          echo "Fetching URLs from resource group: $RG"

          # Get Static Web App URL
          SWA_URL=$(az staticwebapp list --resource-group $RG --query "[0].defaultHostname" -o tsv 2>/dev/null || echo "")
          if [ -z "$SWA_URL" ]; then
            echo "::warning::Static Web App not found in $RG. Using placeholder URL."
            SWA_URL="stapp-lum-$ENV-placeholder.azurestaticapps.net"
          fi
          echo "Static Web App URL: $SWA_URL"
          echo "static_web_app_url=$SWA_URL" >> $GITHUB_OUTPUT

          # Get App Service URL (filter out Function Apps)
          APP_URL=$(az webapp list --resource-group $RG --query "[?contains(kind, 'app') && !contains(kind, 'functionapp')].defaultHostName" -o tsv 2>/dev/null | head -1 || echo "")
          if [ -z "$APP_URL" ]; then
            echo "::warning::App Service not found in $RG. Using placeholder URL."
            APP_URL="app-lum-$ENV-placeholder.azurewebsites.net"
          fi
          echo "App Service URL: $APP_URL"
          echo "app_service_url=$APP_URL" >> $GITHUB_OUTPUT

          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "build_config=${{ steps.env.outputs.build_config }}" >> $GITHUB_OUTPUT
        working-directory: .

  # ===========================================================================
  # Build and Test (all PRs and pushes)
  # ===========================================================================
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    needs: fetch-azure-config

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './clients/package-lock.json'

      - name: Install dependencies
        run: npm ci
        working-directory: ./clients

      - name: Configure environment URLs
        run: |
          ENV="${{ needs.fetch-azure-config.outputs.environment }}"
          SWA_URL="${{ needs.fetch-azure-config.outputs.static_web_app_url }}"
          APP_URL="${{ needs.fetch-azure-config.outputs.app_service_url }}"

          echo "Configuring environment for: $ENV"
          echo "  API URL: https://$SWA_URL/api"
          echo "  SignalR URL: https://$APP_URL/hubs/sync"

          # Determine which environment file to update
          if [ "$ENV" == "prd" ]; then
            ENV_FILE="src/environments/environment.production.ts"
          else
            ENV_FILE="src/environments/environment.$ENV.ts"
          fi

          # Update the environment file with actual URLs
          sed -i "s|apiUrl:.*|apiUrl: 'https://$SWA_URL/api',|" "$ENV_FILE"
          sed -i "s|signalRUrl:.*|signalRUrl: 'https://$APP_URL/hubs/sync',|" "$ENV_FILE"

          echo "Updated $ENV_FILE:"
          grep -E "(apiUrl|signalRUrl)" "$ENV_FILE"

      - name: Run linting
        run: npm run lint --if-present
        continue-on-error: true

      - name: Run type checking
        run: npm run typecheck

      - name: Build Angular app
        run: npm run build -- --configuration ${{ needs.fetch-azure-config.outputs.build_config }}

  # ===========================================================================
  # Build Linux (Ubuntu)
  # ===========================================================================
  build-linux:
    name: Build Linux (${{ needs.fetch-azure-config.outputs.environment }})
    runs-on: ubuntu-latest
    needs: [fetch-azure-config, build-and-test]
    if: github.event_name == 'push' || github.event.inputs.create_release == 'true'

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          # Note: npm cache disabled for electron builds due to app-builder-bin binary corruption issues

      - name: Install dependencies
        run: npm ci
        working-directory: ./clients

      # Create isolated electron-builder installation to bypass npm workspace resolution issues
      # This completely avoids the app-builder-bin ENOENT errors caused by workspace hoisting
      - name: Setup isolated electron-builder
        run: |
          echo "Creating isolated electron-builder installation..."
          mkdir -p /tmp/eb-tools
          cd /tmp/eb-tools
          cat > package.json << 'EOF'
          {
            "name": "eb-tools",
            "version": "1.0.0",
            "private": true,
            "dependencies": {
              "electron-builder": "25.1.8"
            }
          }
          EOF
          npm install --no-audit --no-fund
          echo "Verifying app-builder-bin binary..."
          ls -la node_modules/app-builder-bin/linux/x64/app-builder
          chmod +x node_modules/app-builder-bin/linux/x64/app-builder
          echo "Isolated electron-builder ready at /tmp/eb-tools"

      - name: Configure environment URLs
        run: |
          ENV="${{ needs.fetch-azure-config.outputs.environment }}"
          SWA_URL="${{ needs.fetch-azure-config.outputs.static_web_app_url }}"
          APP_URL="${{ needs.fetch-azure-config.outputs.app_service_url }}"

          echo "Configuring environment for: $ENV"
          echo "  API URL: https://$SWA_URL/api"
          echo "  SignalR URL: https://$APP_URL/hubs/sync"

          # Determine which environment file to update
          if [ "$ENV" == "prd" ]; then
            ENV_FILE="src/environments/environment.production.ts"
          else
            ENV_FILE="src/environments/environment.$ENV.ts"
          fi

          # Update the environment file with actual URLs
          sed -i "s|apiUrl:.*|apiUrl: 'https://$SWA_URL/api',|" "$ENV_FILE"
          sed -i "s|signalRUrl:.*|signalRUrl: 'https://$APP_URL/hubs/sync',|" "$ENV_FILE"

          echo "Updated $ENV_FILE:"
          grep -E "(apiUrl|signalRUrl)" "$ENV_FILE"

      - name: Build Angular app
        run: npm run build -- --configuration ${{ needs.fetch-azure-config.outputs.build_config }}

      - name: Generate icons
        run: |
          mkdir -p build/icons
          mkdir -p assets

          # Install ImageMagick
          sudo apt-get update && sudo apt-get install -y imagemagick

          # Copy icon from central location
          cp ../../assets/icons/icon.png build/icons/icon.png

          # Create multiple sizes for Linux
          for size in 16 32 48 64 128 256 512; do
            convert build/icons/icon.png -resize ${size}x${size} build/icons/${size}x${size}.png
          done

      - name: Build Electron (Linux)
        run: /tmp/eb-tools/node_modules/.bin/electron-builder build --linux --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v6
        with:
          name: linux-build-${{ needs.fetch-azure-config.outputs.environment }}
          path: |
            clients/display/release/*.AppImage
            clients/display/release/*.deb
            clients/display/release/*.tar.gz
          retention-days: 7
          if-no-files-found: warn

  # ===========================================================================
  # Build Windows
  # ===========================================================================
  build-windows:
    name: Build Windows (${{ needs.fetch-azure-config.outputs.environment }})
    runs-on: windows-latest
    needs: [fetch-azure-config, build-and-test]
    if: github.event_name == 'push' || github.event.inputs.create_release == 'true'

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          # Note: npm cache disabled for electron builds due to app-builder-bin binary corruption issues

      - name: Install dependencies
        run: npm ci
        working-directory: ./clients

      # Create isolated electron-builder installation to bypass npm workspace resolution issues
      # This completely avoids the app-builder-bin ENOENT errors caused by workspace hoisting
      - name: Setup isolated electron-builder
        shell: pwsh
        run: |
          Write-Host "Creating isolated electron-builder installation..."
          New-Item -ItemType Directory -Force -Path C:\eb-tools
          Set-Location C:\eb-tools
          @'
          {
            "name": "eb-tools",
            "version": "1.0.0",
            "private": true,
            "dependencies": {
              "electron-builder": "25.1.8"
            }
          }
          '@ | Out-File -FilePath package.json -Encoding UTF8
          npm install --no-audit --no-fund
          Write-Host "Verifying app-builder-bin binary..."
          Get-Item node_modules\app-builder-bin\win\x64\app-builder.exe
          Write-Host "Isolated electron-builder ready at C:\eb-tools"

      - name: Configure environment URLs
        shell: pwsh
        run: |
          $ENV = "${{ needs.fetch-azure-config.outputs.environment }}"
          $SWA_URL = "${{ needs.fetch-azure-config.outputs.static_web_app_url }}"
          $APP_URL = "${{ needs.fetch-azure-config.outputs.app_service_url }}"

          Write-Host "Configuring environment for: $ENV"
          Write-Host "  API URL: https://$SWA_URL/api"
          Write-Host "  SignalR URL: https://$APP_URL/hubs/sync"

          # Determine which environment file to update
          if ($ENV -eq "prd") {
            $ENV_FILE = "src/environments/environment.production.ts"
          } else {
            $ENV_FILE = "src/environments/environment.$ENV.ts"
          }

          # Read the file content
          $content = Get-Content $ENV_FILE -Raw

          # Update the URLs
          $content = $content -replace "apiUrl:.*", "apiUrl: 'https://$SWA_URL/api',"
          $content = $content -replace "signalRUrl:.*", "signalRUrl: 'https://$APP_URL/hubs/sync',"

          # Write back
          Set-Content $ENV_FILE $content

          Write-Host "Updated $ENV_FILE"
          Get-Content $ENV_FILE | Select-String -Pattern "(apiUrl|signalRUrl)"

      - name: Build Angular app
        run: npm run build -- --configuration ${{ needs.fetch-azure-config.outputs.build_config }}

      - name: Generate icons
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path build/icons
          New-Item -ItemType Directory -Force -Path assets

          # Copy icon from central location
          Copy-Item "..\..\assets\icons\icon.png" -Destination "build\icons\icon.png"

          # Install ImageMagick
          choco install imagemagick -y --no-progress

          # Refresh PATH to include ImageMagick
          $env:Path = [System.Environment]::GetEnvironmentVariable("Path","Machine") + ";" + [System.Environment]::GetEnvironmentVariable("Path","User")

          # Generate multiple sizes and create ICO
          $sizes = @(16, 32, 48, 64, 128, 256)
          $icoInputs = @()
          foreach ($size in $sizes) {
            magick build/icons/icon.png -resize "${size}x${size}" "build/icons/${size}x${size}.png"
            $icoInputs += "build/icons/${size}x${size}.png"
          }
          # Create ICO file
          magick $icoInputs build/icon.ico

      - name: Build Electron (Windows)
        run: C:\eb-tools\node_modules\.bin\electron-builder.cmd build --win --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v6
        with:
          name: windows-build-${{ needs.fetch-azure-config.outputs.environment }}
          path: |
            clients/display/release/*.exe
            clients/display/release/*.msi
          retention-days: 7
          if-no-files-found: warn

  # ===========================================================================
  # Build macOS (Intel x64)
  # ===========================================================================
  build-macos-intel:
    name: Build macOS Intel (${{ needs.fetch-azure-config.outputs.environment }})
    runs-on: macos-15  # Intel runner (macos-13 deprecated)
    needs: [fetch-azure-config, build-and-test]
    if: github.event_name == 'push' || github.event.inputs.create_release == 'true'

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          # Note: npm cache disabled for electron builds due to app-builder-bin binary corruption issues

      - name: Install dependencies
        run: npm ci
        working-directory: ./clients

      # Create isolated electron-builder installation to bypass npm workspace resolution issues
      # This completely avoids the app-builder-bin ENOENT errors caused by workspace hoisting
      - name: Setup isolated electron-builder
        run: |
          echo "Creating isolated electron-builder installation..."
          mkdir -p /tmp/eb-tools
          cd /tmp/eb-tools
          cat > package.json << 'EOF'
          {
            "name": "eb-tools",
            "version": "1.0.0",
            "private": true,
            "dependencies": {
              "electron-builder": "25.1.8"
            }
          }
          EOF
          npm install --no-audit --no-fund
          echo "Verifying app-builder-bin binary..."
          ls -la node_modules/app-builder-bin/mac/app-builder_amd64
          chmod +x node_modules/app-builder-bin/mac/app-builder_amd64
          echo "Isolated electron-builder ready at /tmp/eb-tools"

      - name: Configure environment URLs
        run: |
          ENV="${{ needs.fetch-azure-config.outputs.environment }}"
          SWA_URL="${{ needs.fetch-azure-config.outputs.static_web_app_url }}"
          APP_URL="${{ needs.fetch-azure-config.outputs.app_service_url }}"

          echo "Configuring environment for: $ENV"
          echo "  API URL: https://$SWA_URL/api"
          echo "  SignalR URL: https://$APP_URL/hubs/sync"

          # Determine which environment file to update
          if [ "$ENV" == "prd" ]; then
            ENV_FILE="src/environments/environment.production.ts"
          else
            ENV_FILE="src/environments/environment.$ENV.ts"
          fi

          # Update the environment file with actual URLs (macOS sed syntax)
          sed -i '' "s|apiUrl:.*|apiUrl: 'https://$SWA_URL/api',|" "$ENV_FILE"
          sed -i '' "s|signalRUrl:.*|signalRUrl: 'https://$APP_URL/hubs/sync',|" "$ENV_FILE"

          echo "Updated $ENV_FILE:"
          grep -E "(apiUrl|signalRUrl)" "$ENV_FILE"

      - name: Build Angular app
        run: npm run build -- --configuration ${{ needs.fetch-azure-config.outputs.build_config }}

      - name: Generate icons
        run: |
          mkdir -p build/icons
          mkdir -p assets

          # Copy icon from central location
          cp ../../assets/icons/icon.png build/icons/icon.png

          # Install ImageMagick via Homebrew
          brew install imagemagick --quiet || true

          # Create iconset directory for macOS
          mkdir -p build/icon.iconset

          # Generate all required sizes for macOS
          for size in 16 32 64 128 256 512; do
            magick build/icons/icon.png -resize ${size}x${size} build/icon.iconset/icon_${size}x${size}.png
            magick build/icons/icon.png -resize $((size*2))x$((size*2)) build/icon.iconset/icon_${size}x${size}@2x.png
          done

          # Create ICNS file using iconutil
          iconutil -c icns build/icon.iconset -o build/icon.icns

          # Also create icons in the icons folder for Linux compatibility
          for size in 16 32 48 64 128 256 512; do
            magick build/icons/icon.png -resize ${size}x${size} build/icons/${size}x${size}.png
          done

      - name: Build Electron (macOS Intel)
        run: /tmp/eb-tools/node_modules/.bin/electron-builder build --mac --x64 --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # For signed builds, add:
          # CSC_LINK: ${{ secrets.MAC_CERTS }}
          # CSC_KEY_PASSWORD: ${{ secrets.MAC_CERTS_PASSWORD }}
          # APPLE_ID: ${{ secrets.APPLE_ID }}
          # APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          # APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      - name: Upload macOS Intel artifacts
        uses: actions/upload-artifact@v6
        with:
          name: macos-intel-build-${{ needs.fetch-azure-config.outputs.environment }}
          path: |
            clients/display/release/*-x64.dmg
            clients/display/release/*-x64.zip
            clients/display/release/*-x64-mac.zip
          retention-days: 7
          if-no-files-found: warn

  # ===========================================================================
  # Build macOS (Apple Silicon arm64)
  # ===========================================================================
  build-macos-arm:
    name: Build macOS ARM (${{ needs.fetch-azure-config.outputs.environment }})
    runs-on: macos-14  # Apple Silicon runner
    needs: [fetch-azure-config, build-and-test]
    if: github.event_name == 'push' || github.event.inputs.create_release == 'true'

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          # Note: npm cache disabled for electron builds due to app-builder-bin binary corruption issues

      - name: Install dependencies
        run: npm ci
        working-directory: ./clients

      # Create isolated electron-builder installation to bypass npm workspace resolution issues
      # This completely avoids the app-builder-bin ENOENT errors caused by workspace hoisting
      - name: Setup isolated electron-builder
        run: |
          echo "Creating isolated electron-builder installation..."
          mkdir -p /tmp/eb-tools
          cd /tmp/eb-tools
          cat > package.json << 'EOF'
          {
            "name": "eb-tools",
            "version": "1.0.0",
            "private": true,
            "dependencies": {
              "electron-builder": "25.1.8"
            }
          }
          EOF
          npm install --no-audit --no-fund
          echo "Verifying app-builder-bin binary..."
          ls -la node_modules/app-builder-bin/mac/app-builder_arm64
          chmod +x node_modules/app-builder-bin/mac/app-builder_arm64
          echo "Isolated electron-builder ready at /tmp/eb-tools"

      - name: Configure environment URLs
        run: |
          ENV="${{ needs.fetch-azure-config.outputs.environment }}"
          SWA_URL="${{ needs.fetch-azure-config.outputs.static_web_app_url }}"
          APP_URL="${{ needs.fetch-azure-config.outputs.app_service_url }}"

          echo "Configuring environment for: $ENV"
          echo "  API URL: https://$SWA_URL/api"
          echo "  SignalR URL: https://$APP_URL/hubs/sync"

          # Determine which environment file to update
          if [ "$ENV" == "prd" ]; then
            ENV_FILE="src/environments/environment.production.ts"
          else
            ENV_FILE="src/environments/environment.$ENV.ts"
          fi

          # Update the environment file with actual URLs (macOS sed syntax)
          sed -i '' "s|apiUrl:.*|apiUrl: 'https://$SWA_URL/api',|" "$ENV_FILE"
          sed -i '' "s|signalRUrl:.*|signalRUrl: 'https://$APP_URL/hubs/sync',|" "$ENV_FILE"

          echo "Updated $ENV_FILE:"
          grep -E "(apiUrl|signalRUrl)" "$ENV_FILE"

      - name: Build Angular app
        run: npm run build -- --configuration ${{ needs.fetch-azure-config.outputs.build_config }}

      - name: Generate icons
        run: |
          mkdir -p build/icons
          mkdir -p assets

          # Copy icon from central location
          cp ../../assets/icons/icon.png build/icons/icon.png

          # Install ImageMagick via Homebrew
          brew install imagemagick --quiet || true

          # Create iconset directory for macOS
          mkdir -p build/icon.iconset

          # Generate all required sizes for macOS
          for size in 16 32 64 128 256 512; do
            magick build/icons/icon.png -resize ${size}x${size} build/icon.iconset/icon_${size}x${size}.png
            magick build/icons/icon.png -resize $((size*2))x$((size*2)) build/icon.iconset/icon_${size}x${size}@2x.png
          done

          # Create ICNS file using iconutil
          iconutil -c icns build/icon.iconset -o build/icon.icns

          # Also create icons in the icons folder for Linux compatibility
          for size in 16 32 48 64 128 256 512; do
            magick build/icons/icon.png -resize ${size}x${size} build/icons/${size}x${size}.png
          done

      - name: Build Electron (macOS Apple Silicon)
        run: /tmp/eb-tools/node_modules/.bin/electron-builder build --mac --arm64 --publish never
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # For signed builds, add:
          # CSC_LINK: ${{ secrets.MAC_CERTS }}
          # CSC_KEY_PASSWORD: ${{ secrets.MAC_CERTS_PASSWORD }}
          # APPLE_ID: ${{ secrets.APPLE_ID }}
          # APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          # APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      - name: Upload macOS ARM artifacts
        uses: actions/upload-artifact@v6
        with:
          name: macos-arm-build-${{ needs.fetch-azure-config.outputs.environment }}
          path: |
            clients/display/release/*-arm64.dmg
            clients/display/release/*-arm64.zip
            clients/display/release/*-arm64-mac.zip
          retention-days: 7
          if-no-files-found: warn

  # ===========================================================================
  # Create GitHub Release
  # ===========================================================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [fetch-azure-config, build-linux, build-windows, build-macos-intel, build-macos-arm]
    if: startsWith(github.ref, 'refs/tags/display-v') || github.event.inputs.create_release == 'true'

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Determine version
        id: version
        run: |
          ENV="${{ needs.fetch-azure-config.outputs.environment }}"
          if [[ "${{ github.event.inputs.version }}" != "" ]]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == refs/tags/display-v* ]]; then
            echo "version=${GITHUB_REF#refs/tags/display-v}" >> $GITHUB_OUTPUT
          else
            echo "version=$(date +'%Y%m%d')-$(git rev-parse --short HEAD)-$ENV" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: Luminous Display v${{ steps.version.outputs.version }}
          tag_name: display-v${{ steps.version.outputs.version }}
          draft: ${{ github.event.inputs.create_release == 'true' }}
          prerelease: ${{ contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'alpha') }}
          generate_release_notes: true
          files: |
            artifacts/linux-build-${{ needs.fetch-azure-config.outputs.environment }}/*
            artifacts/windows-build-${{ needs.fetch-azure-config.outputs.environment }}/*
            artifacts/macos-intel-build-${{ needs.fetch-azure-config.outputs.environment }}/*
            artifacts/macos-arm-build-${{ needs.fetch-azure-config.outputs.environment }}/*
          body: |
            ## Luminous Display v${{ steps.version.outputs.version }}

            **Environment:** ${{ needs.fetch-azure-config.outputs.environment }}
            **API Endpoint:** https://${{ needs.fetch-azure-config.outputs.static_web_app_url }}/api

            ### Downloads

            | Platform | Architecture | Download |
            |----------|--------------|----------|
            | **Windows** | x64 | `.exe` installer |
            | **macOS** | Apple Silicon (M1/M2/M3) | `-arm64.dmg` |
            | **macOS** | Intel | `-x64.dmg` |
            | **Linux** | x64 | `.AppImage` or `.deb` |

            ### Installation

            #### Windows
            1. Download the `.exe` installer
            2. Run the installer and follow the prompts
            3. Launch Luminous Display from the Start Menu

            #### macOS
            1. Download the appropriate `.dmg` for your Mac:
               - Apple Silicon (M1/M2/M3): `*-arm64.dmg`
               - Intel: `*-x64.dmg`
            2. Open the DMG and drag Luminous Display to Applications
            3. Launch from Applications folder

            #### Linux
            **AppImage (recommended):**
            ```bash
            chmod +x Luminous-Display-*.AppImage
            ./Luminous-Display-*.AppImage
            ```

            **Debian/Ubuntu:**
            ```bash
            sudo dpkg -i luminous-display_*.deb
            ```

            ### Kiosk Mode

            To run in kiosk mode (fullscreen, locked):
            ```bash
            LUMINOUS_KIOSK=true ./Luminous-Display
            ```

            For auto-start configuration, see the [deployment documentation](https://github.com/${{ github.repository }}/blob/main/clients/display/README.md).
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # Security Audit
  # ===========================================================================
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './clients/package-lock.json'

      - name: Run npm audit
        run: |
          npm audit --audit-level=high 2>&1 | tee npm-audit.txt || true
          if grep -q "high\|critical" npm-audit.txt; then
            echo "::warning::Security vulnerabilities detected in display app. Review npm-audit.txt for details."
          fi
        continue-on-error: true

      - name: Upload audit results
        uses: actions/upload-artifact@v6
        with:
          name: display-npm-audit-results
          path: ${{ env.WORKING_DIRECTORY }}/npm-audit.txt
          retention-days: 30
