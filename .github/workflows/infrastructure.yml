# =============================================================================
# Luminous - Infrastructure Deployment Workflow
# =============================================================================
# Validates and deploys Azure infrastructure using Bicep and Azure Verified
# Modules (AVMs). Supports environment-specific deployments (dev, staging, prod).
#
# Phase 0.5.3: GitHub Actions for Bicep deployment
# Phase 0.5.4: Configure environment-specific deployments
# TOGAF Principle: TP-4 - Infrastructure as Code
# ADR-007: Bicep with AVMs for IaC
# =============================================================================

name: Infrastructure Deployment

on:
  push:
    branches: [main, develop]
    paths:
      - 'infra/**'
      - '.github/workflows/infrastructure.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'infra/**'
      - '.github/workflows/infrastructure.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment for deployment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      deploy:
        description: 'Deploy infrastructure (not just validate)'
        required: true
        default: false
        type: boolean

env:
  AZURE_LOCATION: 'eastus2'

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  validate:
    name: Validate Bicep
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Bicep CLI
        run: |
          curl -Lo bicep https://github.com/Azure/bicep/releases/latest/download/bicep-linux-x64
          chmod +x bicep
          sudo mv bicep /usr/local/bin/bicep
          bicep --version

      - name: Lint Bicep files
        run: |
          echo "## Bicep Linting Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Build main.bicep to validate syntax and lint
          bicep build infra/bicep/main.bicep --stdout > /dev/null 2>&1 && \
            echo "main.bicep: Valid" >> $GITHUB_STEP_SUMMARY || \
            (echo "main.bicep: Failed" >> $GITHUB_STEP_SUMMARY && exit 1)

      - name: Validate Bicep templates
        run: |
          # Validate all parameter files
          for param in infra/bicep/parameters/*.bicepparam; do
            echo "Validating: $param"
            bicep build-params "$param" --stdout > /dev/null 2>&1 || exit 1
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All Bicep templates validated successfully." >> $GITHUB_STEP_SUMMARY

  what-if-dev:
    name: What-If (Dev)
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev')
    environment: dev

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Run What-If (Dev)
        uses: azure/arm-deploy@v2
        with:
          scope: subscription
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          region: ${{ env.AZURE_LOCATION }}
          template: infra/bicep/main.bicep
          parameters: infra/bicep/parameters/dev.bicepparam
          deploymentMode: Incremental
          additionalArguments: --what-if

  what-if-staging:
    name: What-If (Staging)
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging'
    environment: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Run What-If (Staging)
        uses: azure/arm-deploy@v2
        with:
          scope: subscription
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          region: ${{ env.AZURE_LOCATION }}
          template: infra/bicep/main.bicep
          parameters: infra/bicep/parameters/staging.bicepparam
          deploymentMode: Incremental
          additionalArguments: --what-if

  what-if-prod:
    name: What-If (Prod)
    runs-on: ubuntu-latest
    needs: validate
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod'
    environment: prod

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Run What-If (Prod)
        uses: azure/arm-deploy@v2
        with:
          scope: subscription
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          region: ${{ env.AZURE_LOCATION }}
          template: infra/bicep/main.bicep
          parameters: infra/bicep/parameters/prod.bicepparam
          deploymentMode: Incremental
          additionalArguments: --what-if

  deploy-dev:
    name: Deploy (Dev)
    runs-on: ubuntu-latest
    needs: [validate, what-if-dev]
    if: |
      (github.ref == 'refs/heads/develop' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'dev' && github.event.inputs.deploy == 'true')
    environment: dev

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy to Dev
        uses: azure/arm-deploy@v2
        id: deploy
        with:
          scope: subscription
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          region: ${{ env.AZURE_LOCATION }}
          template: infra/bicep/main.bicep
          parameters: infra/bicep/parameters/dev.bicepparam
          deploymentName: luminous-dev-${{ github.run_number }}
          failOnStdErr: false

      - name: Output deployment results
        run: |
          echo "## Dev Deployment Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | ${{ steps.deploy.outputs.resourceGroupName }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API URL | ${{ steps.deploy.outputs.appServiceUrl }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Static Web App | ${{ steps.deploy.outputs.staticWebAppUrl }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cosmos DB | ${{ steps.deploy.outputs.cosmosDbAccountName }} |" >> $GITHUB_STEP_SUMMARY

  deploy-staging:
    name: Deploy (Staging)
    runs-on: ubuntu-latest
    needs: [validate, what-if-staging]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging' && github.event.inputs.deploy == 'true'
    environment: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy to Staging
        uses: azure/arm-deploy@v2
        id: deploy
        with:
          scope: subscription
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          region: ${{ env.AZURE_LOCATION }}
          template: infra/bicep/main.bicep
          parameters: infra/bicep/parameters/staging.bicepparam
          deploymentName: luminous-staging-${{ github.run_number }}
          failOnStdErr: false

      - name: Output deployment results
        run: |
          echo "## Staging Deployment Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | ${{ steps.deploy.outputs.resourceGroupName }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API URL | ${{ steps.deploy.outputs.appServiceUrl }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Static Web App | ${{ steps.deploy.outputs.staticWebAppUrl }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cosmos DB | ${{ steps.deploy.outputs.cosmosDbAccountName }} |" >> $GITHUB_STEP_SUMMARY

  deploy-prod:
    name: Deploy (Prod)
    runs-on: ubuntu-latest
    needs: [validate, what-if-prod]
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'prod' && github.event.inputs.deploy == 'true'
    environment: prod

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy to Prod
        uses: azure/arm-deploy@v2
        id: deploy
        with:
          scope: subscription
          subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          region: ${{ env.AZURE_LOCATION }}
          template: infra/bicep/main.bicep
          parameters: infra/bicep/parameters/prod.bicepparam
          deploymentName: luminous-prod-${{ github.run_number }}
          failOnStdErr: false

      - name: Output deployment results
        run: |
          echo "## Production Deployment Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Resource | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Resource Group | ${{ steps.deploy.outputs.resourceGroupName }} |" >> $GITHUB_STEP_SUMMARY
          echo "| API URL | ${{ steps.deploy.outputs.appServiceUrl }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Static Web App | ${{ steps.deploy.outputs.staticWebAppUrl }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cosmos DB | ${{ steps.deploy.outputs.cosmosDbAccountName }} |" >> $GITHUB_STEP_SUMMARY
